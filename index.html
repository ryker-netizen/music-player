<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelSound - Возрождение</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Silkscreen&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --pixel-blue: #0066ff;
            --pixel-purple: #9900ff;
            --pixel-cyan: #00ffff;
            --pixel-pink: #ff00ff;
            --pixel-green: #00ff88;
            --pixel-yellow: #ffff00;
            --pixel-red: #ff4444;
            --pixel-dark: #0a0a1a;
            --pixel-gray: #333344;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(135deg, var(--pixel-dark) 0%, #1a1a3a 100%);
            min-height: 100vh;
            font-family: 'Silkscreen', monospace;
            color: #fff;
            padding: 15px;
            overflow-x: hidden;
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* Красивая шапка из первой версии */
        .header { text-align: center; margin-bottom: 30px; padding: 20px 0; border-bottom: 4px dashed var(--pixel-purple); }
        .title {
            font-family: 'Press Start 2P'; font-size: 1.8rem; color: var(--pixel-cyan);
            text-shadow: 3px 3px 0 var(--pixel-purple); margin-bottom: 10px; line-height: 1.4;
        }
        .subtitle { color: var(--pixel-green); font-size: 0.9rem; letter-spacing: 1px; }

        /* Основной плеер */
        .player-box {
            background: rgba(20, 20, 40, 0.9);
            border: 6px solid;
            border-image: linear-gradient(45deg, var(--pixel-blue), var(--pixel-pink)) 1;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 102, 255, 0.2);
            margin-bottom: 30px;
        }

        /* Экран визуализации */
        .screen-container {
            background: #000;
            border: 4px solid var(--pixel-gray);
            height: 180px;
            margin-bottom: 20px;
            position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* Информация */
        .track-info {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.6); padding: 10px; border: 2px solid var(--pixel-gray);
            margin-bottom: 20px;
        }
        .track-name { color: var(--pixel-yellow); font-family: 'Press Start 2P'; font-size: 0.7rem; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-bits { color: var(--pixel-cyan); font-size: 0.8rem; }

        /* Ползунки */
        .controls { display: grid; gap: 15px; margin-bottom: 20px; }
        .control-row { display: flex; flex-direction: column; gap: 5px; }
        .label { color: var(--pixel-green); font-size: 0.8rem; display: flex; justify-content: space-between; }
        
        input[type=range] {
            width: 100%; height: 15px; -webkit-appearance: none; background: var(--pixel-dark);
            border: 2px solid var(--pixel-gray);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; background: var(--pixel-pink);
            border: 2px solid #fff; cursor: pointer; box-shadow: 2px 2px 0 #000;
        }

        /* Кнопки */
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .pixel-btn {
            font-family: 'Press Start 2P'; font-size: 0.7rem; padding: 15px 5px;
            border: 4px solid #000; cursor: pointer; color: #fff; text-align: center;
            transition: transform 0.1s; text-shadow: 1px 1px 0 #000;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .pixel-btn:active { transform: scale(0.95); }
        .btn-load { background: var(--pixel-blue); }
        .btn-play { background: var(--pixel-green); color: #000; }
        .btn-stop { background: var(--pixel-red); }
        .btn-mode { background: var(--pixel-purple); }

        /* Пианино */
        .piano-box {
            background: rgba(20, 20, 40, 0.9);
            border: 6px solid var(--pixel-green);
            padding: 15px; text-align: center;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        .piano-title { font-family: 'Press Start 2P'; color: var(--pixel-green); margin-bottom: 15px; font-size: 0.8rem; }
        
        .piano {
            display: flex; justify-content: center; height: 100px; position: relative;
            user-select: none;
        }
        .key {
            position: relative; border: 2px solid #000; cursor: pointer;
            transition: background 0.1s;
        }
        .white-key {
            flex: 1; background: #fff; height: 100%; z-index: 1;
            border-radius: 0 0 4px 4px;
        }
        .white-key.active { background: #ddd; transform: translateY(2px); }
        
        .black-key {
            width: 8%; height: 60%; background: #000; z-index: 2;
            margin-left: -4%; margin-right: -4%;
            border-radius: 0 0 3px 3px;
        }
        .black-key.active { background: #333; }

        /* Drop Zone overlay */
        .drop-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.8); z-index: 999;
            display: none; align-items: center; justify-content: center;
            color: var(--pixel-green); font-family: 'Press Start 2P';
            border: 10px dashed var(--pixel-green);
        }
        .dragging .drop-overlay { display: flex; }

    </style>
</head>
<body>
    <div class="drop-overlay">БРОСАЙ ФАЙЛ СЮДА!</div>

    <div class="container">
        <header class="header">
            <h1 class="title">PixelSound</h1>
            <div class="subtitle">ИСТИННЫЙ 8-БИТНЫЙ ЗВУК</div>
        </header>

        <div class="player-box">
            <div class="screen-container">
                <canvas id="vizCanvas"></canvas>
            </div>

            <div class="track-info">
                <div class="track-name" id="trackName">НЕТ КАССЕТЫ</div>
                <div class="track-bits" id="bitDisplay">16-BIT</div>
            </div>

            <div class="controls">
                <div class="control-row">
                    <div class="label"><span>ГРОМКОСТЬ</span> <span id="volVal">80%</span></div>
                    <input type="range" id="volSlider" min="0" max="100" value="80">
                </div>
                <div class="control-row">
                    <div class="label"><span>БИТНОСТЬ (CRUSH)</span> <span id="bitVal">16</span></div>
                    <input type="range" id="bitSlider" min="1" max="16" value="16" step="1" style="direction: rtl">
                </div>
                <div class="control-row">
                    <div class="label"><span>ЧАСТОТА (LOWER)</span> <span id="rateVal">NORM</span></div>
                    <input type="range" id="rateSlider" min="1" max="50" value="1">
                </div>
            </div>

            <div class="btn-grid">
                <button class="pixel-btn btn-load" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> ФАЙЛ
                </button>
                <button class="pixel-btn btn-play" id="btnPlay">
                    <i class="fas fa-play"></i> ИГРАТЬ
                </button>
                <button class="pixel-btn btn-stop" id="btnStop">
                    <i class="fas fa-stop"></i> СТОП
                </button>
                <button class="pixel-btn btn-mode" id="btnMode">
                    <i class="fas fa-wave-square"></i> ВИД
                </button>
            </div>
        </div>

        <div class="piano-box">
            <div class="piano-title">СИНТЕЗАТОР</div>
            <div class="piano" id="pianoKeys">
                </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="audio/*" style="display:none">

    <script>
        // === АУДИО ДВИЖОК (МОЩНЫЙ) ===
        class AudioEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.source = null;
                this.buffer = null;
                
                // Создаем узлы
                this.gainNode = this.ctx.createGain();
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 512;
                
                // Эффект ScriptProcessor (для настоящего 8-бит звука)
                this.processor = this.ctx.createScriptProcessor(4096, 1, 1);
                this.bitDepth = 16;
                this.sampleFactor = 1;
                
                this.setupProcessor();
                
                // Цепочка: Processor -> Gain -> Analyser -> Out
                this.processor.connect(this.gainNode);
                this.gainNode.connect(this.analyser);
                this.analyser.connect(this.ctx.destination);
            }

            setupProcessor() {
                this.processor.onaudioprocess = (e) => {
                    const input = e.inputBuffer.getChannelData(0);
                    const output = e.outputBuffer.getChannelData(0);
                    const step = Math.pow(0.5, this.bitDepth); // Шаг квантования

                    for (let i = 0; i < input.length; i++) {
                        let sample = input[i];

                        // 1. Понижение частоты (Downsampling)
                        // Берем значение только каждый N-й раз, иначе повторяем старое
                        const index = Math.floor(i / this.sampleFactor) * this.sampleFactor;
                        sample = input[index] || 0;

                        // 2. Биткраш (Bitcrushing)
                        if (this.bitDepth < 16) {
                            sample = Math.floor(sample / step) * step;
                        }

                        output[i] = sample;
                    }
                };
            }

            async loadFile(file) {
                const arrayBuffer = await file.arrayBuffer();
                this.buffer = await this.ctx.decodeAudioData(arrayBuffer);
                return this.buffer;
            }

            play() {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                if (!this.buffer) return;
                
                this.stop(false); // Остановить предыдущее, но не сбрасывать
                
                this.source = this.ctx.createBufferSource();
                this.source.buffer = this.buffer;
                this.source.connect(this.processor); // Подключаем к процессору эффектов
                this.source.start(0);
                
                this.source.onended = () => document.getElementById('btnPlay').innerHTML = '<i class="fas fa-play"></i> ИГРАТЬ';
            }

            playTone(freq) {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const env = this.ctx.createGain();
                
                // Выбираем форму волны в зависимости от "жесткости" настроек
                osc.type = this.bitDepth < 6 ? 'square' : 'sawtooth';
                osc.frequency.value = freq;
                
                env.gain.setValueAtTime(0.2, this.ctx.currentTime);
                env.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                
                osc.connect(this.processor); // Звук клавиш тоже проходит через эффекты!
                osc.connect(env).connect(this.processor);
                
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            }

            stop(fullStop = true) {
                if (this.source) {
                    try { this.source.stop(); } catch(e){}
                    this.source.disconnect();
                }
                if(fullStop) this.source = null;
            }

            setParams(vol, bits, rate) {
                this.gainNode.gain.value = vol;
                this.bitDepth = bits;
                this.sampleFactor = rate;
            }
        }

        // === ИНТЕРФЕЙС И ЛОГИКА ===
        const audio = new AudioEngine();
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        let vizMode = 0; // 0 - Спектр, 1 - Волна

        // Элементы UI
        const fileInput = document.getElementById('fileInput');
        const trackName = document.getElementById('trackName');
        const volSlider = document.getElementById('volSlider');
        const bitSlider = document.getElementById('bitSlider');
        const rateSlider = document.getElementById('rateSlider');

        // Обработка файла
        fileInput.onchange = async (e) => {
            if (e.target.files[0]) {
                trackName.textContent = "ЗАГРУЗКА...";
                await audio.loadFile(e.target.files[0]);
                trackName.textContent = e.target.files[0].name.toUpperCase();
                document.getElementById('btnPlay').click();
            }
        };

        // Кнопки
        document.getElementById('btnPlay').onclick = () => {
            audio.play();
            document.getElementById('btnPlay').innerHTML = '<i class="fas fa-pause"></i> ИГРАЕТ';
        };
        document.getElementById('btnStop').onclick = () => {
            audio.stop();
            document.getElementById('btnPlay').innerHTML = '<i class="fas fa-play"></i> ИГРАТЬ';
        };
        document.getElementById('btnMode').onclick = () => vizMode = (vizMode + 1) % 2;

        // Слайдеры (обновление в реальном времени)
        function updateAudioParams() {
            const vol = volSlider.value / 100;
            const bits = parseInt(bitSlider.value);
            const rate = parseInt(rateSlider.value);
            
            audio.setParams(vol, bits, rate);
            
            // Обновление текстов
            document.getElementById('volVal').textContent = volSlider.value + '%';
            document.getElementById('bitVal').textContent = bits + (bits < 16 ? '-BIT' : '');
            document.getElementById('rateVal').textContent = rate === 1 ? 'NORM' : 'LOW';
            document.getElementById('bitDisplay').textContent = `${bits}-BIT`;
        }

        [volSlider, bitSlider, rateSlider].forEach(el => el.addEventListener('input', updateAudioParams));

        // === ВИЗУАЛИЗАЦИЯ ===
        function drawViz() {
            requestAnimationFrame(drawViz);
            
            // Подгонка размера канваса
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const w = canvas.width;
            const h = canvas.height;
            const bufferLength = audio.analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            if (vizMode === 0) { // СПЕКТР
                audio.analyser.getByteFrequencyData(data);
                const barWidth = (w / bufferLength) * 2.5;
                let x = 0;
                
                for(let i = 0; i < bufferLength; i++) {
                    const barHeight = (data[i] / 255) * h;
                    
                    // Цвет меняется от высоты + времени
                    const hue = i + Date.now() / 50;
                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    ctx.fillRect(x, h - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            } else { // ВОЛНА
                audio.analyser.getByteTimeDomainData(data);
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#00ff88';
                ctx.beginPath();
                
                const sliceWidth = w / bufferLength;
                let x = 0;
                
                for(let i = 0; i < bufferLength; i++) {
                    const v = data[i] / 128.0;
                    const y = v * h / 2;
                    
                    if(i===0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                ctx.stroke();
            }
        }
        drawViz();

        // === ПИАНИНО (Генерация клавиш) ===
        function createPiano() {
            const container = document.getElementById('pianoKeys');
            const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B']; // Только белые для простоты разметки
            const freqs = [261.6, 293.6, 329.6, 349.2, 392.0, 440.0, 493.8];
            const blackFreqs = [277.2, 311.1, null, 370.0, 415.3, 466.2]; // C#, D#, -, F#, G#, A#

            for(let i = 0; i < 7; i++) {
                // Белая клавиша
                const whiteKey = document.createElement('div');
                whiteKey.className = 'key white-key';
                whiteKey.onmousedown = () => {
                    whiteKey.classList.add('active');
                    audio.playTone(freqs[i]);
                };
                whiteKey.onmouseup = whiteKey.onmouseleave = () => whiteKey.classList.remove('active');
                container.appendChild(whiteKey);

                // Черная клавиша (если есть)
                if (i !== 2 && i !== 6) { // E и B не имеют диезов справа в этой октаве
                    const blackKey = document.createElement('div');
                    blackKey.className = 'key black-key';
                    // Находим правильную частоту для черной клавиши
                    let bIndex = i > 2 ? i - 1 : i; 
                    blackKey.onmousedown = () => {
                        blackKey.classList.add('active');
                        audio.playTone(blackFreqs[bIndex]);
                    };
                    blackKey.onmouseup = blackKey.onmouseleave = () => blackKey.classList.remove('active');
                    container.appendChild(blackKey);
                }
            }
        }
        createPiano();

        // Drag & Drop
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            document.body.classList.add('dragging');
        });
        document.body.addEventListener('dragleave', () => document.body.classList.remove('dragging'));
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            document.body.classList.remove('dragging');
            if(e.dataTransfer.files[0]) {
                fileInput.files = e.dataTransfer.files;
                fileInput.onchange({target: fileInput});
            }
        });

    </script>
</body>
</html>

